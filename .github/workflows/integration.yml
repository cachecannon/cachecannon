name: Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  redis:
    name: Redis
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release
      - name: Run benchmark against Redis
        run: ./target/release/cachecannon config/redis-ci.toml

  valkey:
    name: Valkey
    runs-on: ubuntu-latest
    services:
      valkey:
        image: valkey/valkey:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "valkey-cli ping"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release
      - name: Run benchmark against Valkey
        run: ./target/release/cachecannon config/redis-ci.toml

  redis-tls:
    name: Redis TLS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install Redis and generate TLS certificates
        run: |
          sudo apt-get update && sudo apt-get install -y redis-server

          mkdir -p /tmp/redis-tls
          openssl req -x509 -newkey rsa:4096 -sha256 -days 1 \
            -nodes -keyout /tmp/redis-tls/redis.key \
            -out /tmp/redis-tls/redis.crt \
            -subj "/CN=localhost" \
            -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"
          cp /tmp/redis-tls/redis.crt /tmp/redis-tls/ca.crt

      - name: Start Redis with TLS
        run: |
          redis-server \
            --tls-port 6380 \
            --port 0 \
            --tls-cert-file /tmp/redis-tls/redis.crt \
            --tls-key-file /tmp/redis-tls/redis.key \
            --tls-ca-cert-file /tmp/redis-tls/ca.crt \
            --tls-auth-clients no \
            --daemonize yes

          # Wait for Redis to be ready (fail if it never responds)
          for i in $(seq 1 30); do
            if redis-cli --tls \
              --cert /tmp/redis-tls/redis.crt --key /tmp/redis-tls/redis.key \
              --cacert /tmp/redis-tls/ca.crt \
              -p 6380 ping 2>/dev/null | grep -q PONG; then
              echo "Redis TLS is ready"
              exit 0
            fi
            echo "Waiting for Redis TLS... ($i)"
            sleep 1
          done
          echo "ERROR: Redis TLS never became ready"
          exit 1

      - name: Build
        run: cargo build --release

      - name: Run benchmark against Redis TLS
        run: ./target/release/cachecannon config/redis-tls-ci.toml
